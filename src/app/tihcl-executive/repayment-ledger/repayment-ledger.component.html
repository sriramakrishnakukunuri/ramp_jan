<main class="pt-80">
    <section class="pt-3">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header bg-theme text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">View Repayments</h6>
                    <div class="d-flex gap-2">
                        <button 
                            type="button" 
                            class="btn btn-light btn-sm"
                            data-bs-toggle="modal" 
                            data-bs-target="#ledgerReceivablesModal"
                             (click)="resetForm()"
                            [disabled]="!loanApplicationNo">
                           
                            <i class="bi bi-plus-circle me-1"></i>
                            Add Receivables
                        </button>
                        <button 
                            type="button" 
                            class="btn btn-light btn-sm"
                            data-bs-toggle="modal" 
                              (click)="resetForm()"
                            data-bs-target="#ledgerPayablesModal"
                            [disabled]="!loanApplicationNo">
                            <i class="bi bi-plus-circle me-1"></i>
                            Add Payments
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="alert alert-info">
                                <strong>Application No : </strong> <span>{{ loanApplicationNo }}</span> &nbsp; | &nbsp;
                                <strong>Enterprise Name : </strong><span>{{ selectedApplicationData?.enterpriseName }}</span> 
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Select Application No</mat-label>
                                <mat-select [(ngModel)]="loanApplicationNo" (selectionChange)="onApplicationNoChange($event.value)">
                                    <mat-select-filter [array]="enterpriseList" [displayMember]="'applicationNo'"
                                        (filteredReturn)="filteredEnterprise = $event">
                                    </mat-select-filter>
                                    <mat-option *ngFor="let question of filteredEnterprise"
                                        [value]="question.applicationNo">
                                        {{ question?.applicationNo }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <table id="repayment_ledger_table" class="table table-bordered table-striped w-100 fs-md mt-0">
                        <thead class="bg-theme text-white">
                            <tr>
                                <th rowspan="2">Date</th>
                                <th rowspan="2">Narration</th>
                                <th colspan="3" class="text-center text-white">Debit</th>
                                <th colspan="3" class="text-center text-white">Credit</th>
                                <th colspan="4" class="text-center">Outstanding Balance</th>
                            </tr>
                            <tr>
                                <th>Charges</th>
                                <th>Interest</th>
                                <th>Principal</th>
                                <th>Charges</th>
                                <th>Interest</th>
                                <th>Principal</th>
                                <th>Charges</th>
                                <th>Interest</th>
                                <th>Principal</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody *ngIf="repaymentLedgerList?.length > 0">
                            <tr *ngFor="let row of repaymentLedgerList">
                                <td>{{ row?.date }}</td>
                                <td>{{ row?.narration }}</td>
                                <td>{{ row?.debitCharges ?? 0 }}</td>
                                <td>{{ row?.debitInterest ?? 0 }}</td>
                                <td>{{ row?.debitPrincipal ?? 0 }}</td>
                                <td>{{ row?.creditCharges ?? 0 }}</td>
                                <td>{{ row?.creditInterest ?? 0 }}</td>
                                <td>{{ row?.creditPrincipal ?? 0 }}</td>
                                <td>{{ row?.outstandingCharges ?? 0 }}</td>
                                <td>{{ row?.outstandingInterest ?? 0 }}</td>
                                <td>{{ row?.outstandingPrincipal ?? 0 }}</td>
                                <td>{{ row?.outstandingTotal ?? 0 }}</td>
                            </tr>
                        </tbody>
                        <tbody *ngIf="!repaymentLedgerList || repaymentLedgerList.length === 0">
                            <tr>
                                <td colspan="12" class="text-center">Data not available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Ledger Receivables Modal -->
<div class="modal fade" id="ledgerReceivablesModal" #ledgerReceivablesModal tabindex="-1" aria-labelledby="ledgerReceivablesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2 bg-theme">
                <h6 class="modal-title text-white" id="ledgerReceivablesModalLabel">
                    <i class="bi bi-receipt me-2"></i>
                    Add Receivables 
                </h6>
                <button type="button" class="btn-close text-white fs-4 p-0" data-bs-dismiss="modal"  aria-label="Close">
                    <span class="bi bi-x"></span>
                </button>
            </div>
            <div class="modal-body">
                <form [formGroup]="ledgerForm" (ngSubmit)="onSubmit()">
                    <div class="row mb-3">
                       <div class="col-12">
                            <div class="alert alert-info">
                                <strong>Application No : </strong> <span>{{ loanApplicationNo }}</span> &nbsp; | &nbsp;
                                <strong>Enterprise Name : </strong><span>{{ selectedApplicationData?.enterpriseName }}</span> 
                            </div>
                        </div>
                    </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="transactionDateModal" formControlName="transactionDate" placeholder="">
                                <label for="transactionDateModal">Transaction Date <span class="text-danger">*</span></label>
                                <div *ngIf="f['transactionDate'].invalid && f['transactionDate'].touched" class="text-danger">
                                    Transaction date is required
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                             <app-indian-rupees-input formControlName="chargesAmount" label="Charges Amount" 
                               placeholder="Enter Amount"></app-indian-rupees-input>
                            <div class="form-floating">
                                <!-- <input type="number" class="form-control" id="chargesAmountModal" formControlName="chargesAmount" placeholder="0.00" min="0" step="0.01">
                                <label for="chargesAmountModal">Charges Amount <span class="text-danger">*</span></label> -->
                                <div *ngIf="f['chargesAmount'].invalid && f['chargesAmount'].touched" class="text-danger">
                                    Valid charges amount is required
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="chargesNarrationModal" formControlName="chargesNarration" placeholder="" [required]="f['chargesAmount'].value > 0">
                                <label for="chargesNarrationModal">Charges Narration <span *ngIf="f['chargesAmount'].value > 0" class="text-danger">*</span></label>
                                <div *ngIf="f['chargesNarration'].invalid && f['chargesNarration'].touched" class="text-danger">
                                    Charges narration is required
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <app-indian-rupees-input formControlName="interestAmount" label="Interest Amount"  [required]="true"
                               placeholder="Enter Amount"></app-indian-rupees-input>
                            <div class="form-floating">
                                <!-- <input type="number" class="form-control" id="interestAmountModal" formControlName="interestAmount" placeholder="0.00" min="0" step="0.01">
                                <label for="interestAmountModal">Interest Amount <span class="text-danger">*</span></label> -->
                                <div *ngIf="f['interestAmount'].invalid && f['interestAmount'].touched" class="text-danger">
                                    Valid interest amount is required
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="interestNarrationModal" formControlName="interestNarration" placeholder="" [required]="f['interestAmount'].value > 0">
                                <label for="interestNarrationModal">Interest Narration <span *ngIf="f['interestAmount'].value > 0" class="text-danger">*</span></label>
                                <div *ngIf="f['interestNarration'].invalid && f['interestNarration'].touched" class="text-danger">
                                    Interest narration is required
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <app-indian-rupees-input formControlName="principalAmount" label="Principal Amount" [required]="true"
                               placeholder="Enter Amount"></app-indian-rupees-input>
                            <div class="form-floating">
                                <!-- <input type="number" class="form-control" id="principalAmountModal" formControlName="principalAmount" placeholder="0.00" min="0" step="0.01">
                                <label for="principalAmountModal">Principal Amount <span class="text-danger">*</span></label> -->
                                <div *ngIf="f['principalAmount'].invalid && f['principalAmount'].touched" class="text-danger">
                                    Valid principal amount is required
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="principalNarrationModal" formControlName="principalNarration" placeholder="" [required]="f['principalAmount'].value > 0">
                                <label for="principalNarrationModal">Principal Narration <span *ngIf="f['principalAmount'].value > 0" class="text-danger">*</span></label>
                                <div *ngIf="f['principalNarration'].invalid && f['principalNarration'].touched" class="text-danger">
                                    Principal narration is required
                                </div>
                            </div>
                        </div>
                        </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Close</button>
                        <button type="submit" class="btn btn-primary me-2" [disabled]="ledgerForm.invalid || isSubmitting">
                            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <i *ngIf="!isSubmitting" class="bi bi-save me-1"></i>
                            {{ isSubmitting ? 'Saving...' : 'Save' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ledgerPayablesModal" #ledgerPayablesModal tabindex="-1" aria-labelledby="ledgerPayablesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2 bg-theme">
                <h6 class="modal-title text-white" id="ledgerPayablesModalLabel">
                    <i class="bi bi-receipt me-2"></i>
                    Add Payments 
                </h6>
                <button type="button" class="btn-close text-white fs-4 p-0" data-bs-dismiss="modal"  aria-label="Close">
                    <span class="bi bi-x"></span>
                </button>
            </div>
            <div class="modal-body">
                <form [formGroup]="ledgerForm" (ngSubmit)="onSubmitPayables()">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>Application No : </strong> <span>{{ loanApplicationNo }}</span> &nbsp; | &nbsp;
                                <strong>Enterprise Name : </strong><span>{{ selectedApplicationData?.enterpriseName }}</span> 
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="transactionDateModal" max="{{ today | date:'yyyy-MM-dd' }}" formControlName="transactionDate" placeholder="">
                                <label for="transactionDateModal">Transaction Date <span class="text-danger">*</span></label>
                                <div *ngIf="f['transactionDate'].invalid && f['transactionDate'].touched" class="text-danger">
                                    Transaction date is required
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <app-indian-rupees-input formControlName="chargesAmount" label="Charges Amount"  [required]="true"
                               placeholder="Enter Amount"></app-indian-rupees-input>
                            <div class="form-floating">
                                <!-- <input type="number" class="form-control" id="chargesAmountModal" formControlName="chargesAmount" placeholder="0.00" min="0" step="0.01">
                                <label for="chargesAmountModal">Charges Amount <span class="text-danger">*</span></label> -->
                                <div *ngIf="f['chargesAmount'].invalid && f['chargesAmount'].touched" class="text-danger">
                                    Valid charges amount is required
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="chargesNarrationModal" formControlName="chargesNarration" placeholder="" [required]="ledgerForm.get('chargesAmount')?.value > 0">
                                <label for="chargesNarrationModal">Charges Narration <span *ngIf="f['chargesAmount'].value > 0" class="text-danger">*</span></label>
                                <div *ngIf="f['chargesNarration'].invalid && f['chargesNarration'].touched" class="text-danger">
                                    Charges narration is required
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <app-indian-rupees-input formControlName="interestAmount" label="Interest Amount"  [required]="true"
                               placeholder="Enter Amount"></app-indian-rupees-input>
                            <div class="form-floating">
                                <!-- <input type="number" class="form-control" id="interestAmountModal" formControlName="interestAmount" placeholder="0.00" min="0" step="0.01">
                                <label for="interestAmountModal">Interest Amount <span class="text-danger">*</span></label> -->
                                <div *ngIf="f['interestAmount'].invalid && f['interestAmount'].touched" class="text-danger">
                                    Valid interest amount is required
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="interestNarrationModal" formControlName="interestNarration" placeholder="" [required]="f['interestAmount'].value > 0">
                                <label for="interestNarrationModal">Interest Narration <span *ngIf="f['interestAmount'].value > 0"  class="text-danger">*</span></label>
                                <div *ngIf="f['interestNarration'].invalid && f['interestNarration'].touched" class="text-danger">
                                    Interest narration is required
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <app-indian-rupees-input formControlName="principalAmount" label="Principal Amount"  [required]="true"
                               placeholder="Enter Amount"></app-indian-rupees-input>
                            <div class="form-floating">
                                <!-- <input type="number" class="form-control" id="principalAmountModal" formControlName="principalAmount" placeholder="0.00" min="0" step="0.01">
                                <label for="principalAmountModal">Principal Amount <span class="text-danger">*</span></label> -->
                                <div *ngIf="f['principalAmount'].invalid && f['principalAmount'].touched" class="text-danger">
                                    Valid principal amount is required
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 col-lg-4 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="principalNarrationModal" formControlName="principalNarration" placeholder="" [required]="f['principalAmount'].value > 0">
                                <label for="principalNarrationModal">Principal Narration <span *ngIf="f['principalAmount'].value > 0" class="text-danger">*</span></label>
                                <div *ngIf="f['principalNarration'].invalid && f['principalNarration'].touched" class="text-danger">
                                    Principal narration is required
                                </div>
                            </div>
                        </div>
                        </div>
                    
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Close</button>
                        <button type="submit" class="btn btn-primary me-2" [disabled]="ledgerForm.invalid || isSubmitting">
                            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <i *ngIf="!isSubmitting" class="bi bi-save me-1"></i>
                            {{ isSubmitting ? 'Saving...' : 'Save' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

