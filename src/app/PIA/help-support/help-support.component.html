<main class="mt-4">
  <section>
    <div class="container-fluid">
      <div class="card mb-3">
        <div class="card-header bg-transparent">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="fw-600 mb-0">Help & Support - Ticket Management</h6>
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-lime-green btn-sm" (click)="openTicketModal('add')">
                <i class="fas fa-plus"></i> Add New Ticket
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Message Display -->
          <div *ngIf="message" class="alert" [ngClass]="messageType === 'success' ? 'alert-success' : 'alert-error'">
            {{ message }}
          </div>

          <!-- Loading indicator -->
          <div *ngIf="loading && tickets.length === 0" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading tickets...</p>
          </div>

          <!-- Tickets DataTable -->
          <div class="table-responsive">
            <table id="tickets-table" class="table table-borderless table-striped nowrap">
              <thead class="bg-lime-green text-white">
                <tr>
                  <th>S.No</th>
                  <th>Title</th>
                  <th>Description</th>
                  <th>Type</th>
                  <th>Priority</th>
                  <th>Status</th>
                  <th>Assignee</th>
                  <th>Created Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- DataTable will populate this -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Add/Edit Ticket Modal -->
<div class="modal fade" id="addTicketModal" tabindex="-1" aria-labelledby="addTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title text-white" id="addTicketModalLabel">{{ isEditMode ? 'Update' : 'Add' }} Ticket</h6>
        <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close" (click)="resetTicketForm()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="title" class="form-label">Title *</label>
                <input 
                  type="text" 
                  id="title" 
                  formControlName="title" 
                  class="form-control"
                  [class.is-invalid]="f['title'].invalid && (f['title'].dirty || f['title'].touched)"
                  placeholder="Enter ticket title">
                <div *ngIf="f['title'].invalid && (f['title'].dirty || f['title'].touched)" class="invalid-feedback">
                  <div *ngIf="f['title'].errors?.['required']">Title is required</div>
                  <div *ngIf="f['title'].errors?.['minlength']">Title must be at least 3 characters</div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="type" class="form-label">Type *</label>
                <select 
                  id="type" 
                  formControlName="type" 
                  class="form-select"
                  [class.is-invalid]="f['type'].invalid && (f['type'].dirty || f['type'].touched)">
                  <option value="">Select Type</option>
                  <option *ngFor="let type of types" [value]="type">{{ type }}</option>
                </select>
                <div *ngIf="f['type'].invalid && (f['type'].dirty || f['type'].touched)" class="invalid-feedback">
                  <div *ngIf="f['type'].errors?.['required']">Type is required</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="form-group mb-3">
                <label for="description" class="form-label">Description *</label>
                <textarea 
                  id="description" 
                  formControlName="description" 
                  class="form-control"
                  rows="4"
                  [class.is-invalid]="f['description'].invalid && (f['description'].dirty || f['description'].touched)"
                  placeholder="Describe the issue or request in detail"></textarea>
                <div *ngIf="f['description'].invalid && (f['description'].dirty || f['description'].touched)" class="invalid-feedback">
                  <div *ngIf="f['description'].errors?.['required']">Description is required</div>
                  <div *ngIf="f['description'].errors?.['minlength']">Description must be at least 10 characters</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="priority" class="form-label">Priority *</label>
                <select 
                  id="priority" 
                  formControlName="priority" 
                  class="form-select"
                  [class.is-invalid]="f['priority'].invalid && (f['priority'].dirty || f['priority'].touched)">
                  <option value="">Select Priority</option>
                  <option *ngFor="let priority of priorities" [value]="priority">{{ priority }}</option>
                </select>
                <div *ngIf="f['priority'].invalid && (f['priority'].dirty || f['priority'].touched)" class="invalid-feedback">
                  <div *ngIf="f['priority'].errors?.['required']">Priority is required</div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="status" class="form-label">Status *</label>
                <select 
                  id="status" 
                  formControlName="status" 
                  class="form-select"
                  [class.is-invalid]="f['status'].invalid && (f['status'].dirty || f['status'].touched)">
                  <option value="">Select Status</option>
                  <option *ngFor="let status of statuses" [value]="status">{{ status.replace('_', ' ') }}</option>
                </select>
                <div *ngIf="f['status'].invalid && (f['status'].dirty || f['status'].touched)" class="invalid-feedback">
                  <div *ngIf="f['status'].errors?.['required']">Status is required</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
              <label for="assigneeId" class="form-label">Assignee *</label>
              <select
                id="assigneeId"
                formControlName="assigneeId"
                class="form-select"
                [class.is-invalid]="f['assigneeId'].invalid && (f['assigneeId'].dirty || f['assigneeId'].touched)">
                <option value="">Select Assignee</option>
                <option *ngFor="let assignee of getAssineeData" [value]="assignee.userId">
                {{ assignee.userId }}
                </option>
              </select>
              <div *ngIf="f['assigneeId'].invalid && (f['assigneeId'].dirty || f['assigneeId'].touched)" class="invalid-feedback">
                <div *ngIf="f['assigneeId'].errors?.['required']">Assignee is required</div>
              </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="form-group mb-3">
                <label for="files" class="form-label">Attach Files</label>
                <input 
                  type="file" 
                  id="files" 
                  multiple 
                  (change)="onFileSelect($event)" 
                  class="form-control"
                  accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif">
                
                <!-- Selected Files Display -->
                <div *ngIf="selectedFiles.length > 0" class="selected-files mt-2">
                  <h6 class="text-muted">Selected Files:</h6>
                  <div *ngFor="let file of selectedFiles; let i = index" class="file-item d-flex justify-content-between align-items-center p-2 border rounded mb-1">
                    <span *ngIf="isEditMode"><i class="fas fa-file me-2"></i>{{ file.fileName }}</span>
                    <span *ngIf="!isEditMode"><i class="fas fa-file me-2"></i>{{ file?.name }}</span>
                    <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeFile(i)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-end mt-3">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal" (click)="resetTicketForm()">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn btn-lime-green" 
              [disabled]="loading || ticketForm.invalid">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
              {{ isEditMode ? 'Update Ticket' : 'Create Ticket' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Delete Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this ticket? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDeleteTicket(deleteTicketId)" [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- File Preview Modal -->
<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title text-white" id="filePreviewModalLabel">Ticket Attachments</h6>
        <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-3">
        <!-- Show all files when multiple files exist -->
        <div *ngIf="currentTicketFiles && currentTicketFiles.length > 0" class="files-preview">
          <div *ngFor="let file of currentTicketFiles; let i = index" class="file-preview-item mb-4 border rounded p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="file-info d-flex align-items-center">
                <i [class]="getFileIcon(file.fileName || file.name)" class="me-3 fa-lg"></i>
                <div>
                  <h6 class="mb-1">{{ file.fileName || file.name }}</h6>
                  <small class="text-muted" *ngIf="file.fileSize">Size: {{ formatFileSize(file.fileSize) }}</small>
                </div>
              </div>
              <div class="file-actions">
                <a 
                  [href]="getFileDownloadUrl(file)" 
                  target="_blank" 
                  class="btn btn-lime-green btn-sm"
                  title="Download File">
                  <i class="fas fa-download"></i> Download
                </a>
              </div>
            </div>
            
            <!-- Image Preview -->
            <ng-container *ngIf="getFileType(file.fileName || file.name) === 'image'">
              <img [src]="getFileDownloadUrl(file)" alt="Image Preview" class="img-fluid w-100 rounded" style="max-height: 400px; object-fit: contain;">
            </ng-container>
            
            <!-- PDF Preview -->
            <ng-container *ngIf="getFileType(file.fileName || file.name) === 'pdf'">
              <div class="pdf-container rounded" style="height: 400px;">
                <iframe 
                  [src]="getSafeUrl(getFileDownloadUrl(file))" 
                  width="100%" 
                  height="100%" 
                  frameborder="0"
                  class="rounded">
                  <p>Your browser does not support PDFs. 
                    <a [href]="getFileDownloadUrl(file)" target="_blank">Download the PDF</a>.
                  </p>
                </iframe>
              </div>
            </ng-container>
            
            <!-- Generic File Preview for documents -->
            <ng-container *ngIf="getFileType(file.fileName || file.name) === 'document'">
              <div class="text-center p-4 bg-light rounded">
                <i [class]="getFileIcon(file.fileName || file.name)" class="fa-3x mb-3"></i>
                <p class="text-muted mb-0">This file type cannot be previewed. Click download to view the file.</p>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Single file preview (existing functionality) -->
        <div *ngIf="(!currentTicketFiles || currentTicketFiles.length <= 1) && filePreviewUrl" class="single-file-preview">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">{{ selectedFileName }}</h6>
            <a [href]="filePreviewUrl" target="_blank" class="btn btn-lime-green btn-sm">
              <i class="fas fa-download"></i> Download
            </a>
          </div>
          
          <!-- Image Preview -->
          <ng-container *ngIf="filePreviewType === 'image'">
            <img [src]="filePreviewUrl" alt="Image Preview" class="img-fluid w-100 rounded" style="max-height: 70vh; object-fit: contain;">
          </ng-container>
          
          <!-- PDF Preview -->
          <ng-container *ngIf="filePreviewType === 'pdf'">
            <div class="pdf-container rounded" style="height: 70vh;">
              <iframe 
                [src]="getSafeUrl(filePreviewUrl)" 
                width="100%" 
                height="100%" 
                frameborder="0"
                class="rounded">
                <p>Your browser does not support PDFs. 
                  <a [href]="filePreviewUrl" target="_blank">Download the PDF</a>.
                </p>
              </iframe>
            </div>
          </ng-container>
          
          <!-- Generic File Preview for documents -->
          <ng-container *ngIf="filePreviewType === 'document'">
            <div class="text-center p-4 bg-light rounded">
              <i class="fas fa-file fa-5x mb-3 text-muted"></i>
              <h5>{{ selectedFileName }}</h5>
              <p class="text-muted">This file type cannot be previewed. Click download to view the file.</p>
            </div>
          </ng-container>
        </div>

        <!-- No files available -->
        <div *ngIf="(!currentTicketFiles || currentTicketFiles.length === 0) && !filePreviewUrl" class="text-center p-4">
          <i class="fas fa-folder-open fa-3x mb-3 text-muted"></i>
          <p class="text-muted">No attachments found for this ticket.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View All Files Modal -->
<div class="modal fade" id="viewAllFilesModal" tabindex="-1" aria-labelledby="viewAllFilesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title text-white" id="viewAllFilesModalLabel">Ticket Attachments</h6>
        <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="currentTicketFiles && currentTicketFiles.length > 0" class="files-list">
          <div *ngFor="let file of currentTicketFiles; let i = index" 
               class="file-item d-flex justify-content-between align-items-center p-3 border rounded mb-2">
            <div class="file-info d-flex align-items-center">
              <i [class]="getFileIcon(file.fileName || file.name)" class="me-3 fa-2x"></i>
              <div>
                <h6 class="mb-1">{{ file.fileName || file.name }}</h6>
                <small class="text-muted" *ngIf="file.fileSize">Size: {{ formatFileSize(file.fileSize) }}</small>
              </div>
            </div>
            <div class="file-actions">
              <button 
                type="button" 
                class="btn btn-outline-primary btn-sm me-2" 
                (click)="previewFile(file, i)"
                title="Preview File">
                <i class="fas fa-eye"></i>
              </button>
              <a 
                [href]="getFileDownloadUrl(file)" 
                target="_blank" 
                class="btn btn-outline-success btn-sm"
                title="Download File">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
        </div>
        
        <div *ngIf="!currentTicketFiles || currentTicketFiles.length === 0" class="text-center p-4">
          <i class="fas fa-folder-open fa-3x mb-3 text-muted"></i>
          <p class="text-muted">No attachments found for this ticket.</p>
        </div>
      </div>
    </div>
  </div>
</div>