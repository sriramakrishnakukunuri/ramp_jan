<main class="mt-4">
  <section>
    <div class="container-fluid">
      <div class="card mb-3">
        <div class="card-header bg-transparent">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="fw-600 mb-0">Help & Support - Ticket Management</h6>
            </div>
            <div class="col-auto">
              <button type="button" class="btn btn-lime-green btn-sm" (click)="openTicketModal('add')">
                <i class="fas fa-plus"></i> Add New Ticket
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Message Display -->
          <div *ngIf="message" class="alert" [ngClass]="messageType === 'success' ? 'alert-success' : 'alert-error'">
            {{ message }}
          </div>

          <!-- Loading indicator -->
          <div *ngIf="loading && tickets.length === 0" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading tickets...</p>
          </div>

          <!-- No tickets message -->
          <div *ngIf="tickets.length === 0 && !loading" class="text-center py-5">
            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No tickets found</h5>
            <p class="text-muted">Create your first support ticket using the button above.</p>
          </div>

          <!-- Tickets Table -->
          <div *ngIf="tickets.length > 0" class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-lime-green text-white">
                <tr>
                  <th scope="col">S.No</th>
                  <th scope="col">Title</th>
                  <th scope="col">Description</th>
                  <th scope="col">Type</th>
                  <th scope="col">Priority</th>
                  <th scope="col">Status</th>
                  <th scope="col">Assignee</th>
                  <th scope="col">Created Date</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ticket of tickets; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <div class="fw-600">{{ ticket.title }}</div>
                    
                  </td>
                  <td>
                    <small class="text-muted">{{ ticket.description | slice:0:50 }}{{ ticket.description && ticket.description.length > 50 ? '...' : '' }}</small>
                  </td>
                  <td>
                    <span class="badge type-{{ ticket.type.toLowerCase() }}">{{ ticket.type }}</span>
                  </td>
                  <td>
                    <span class="badge priority-{{ ticket.priority.toLowerCase() }}">{{ ticket.priority }}</span>
                  </td>
                  <td>
                    <span class="badge status-{{ ticket.status.toLowerCase().replace('_', '-') }}">{{ ticket.status.replace('_', ' ') }}</span>
                  </td>
                  <td>
                    <!-- <div class="fw-600">{{ ticket.assigneeName }}</div> -->
                    <small class="text-muted">{{ ticket.assigneeId }}</small>
                  </td>
                  <td>
                    <span *ngIf="ticket?.createdAt">{{ ticket?.createdAt }}</span>
                    <span *ngIf="!ticket?.createdAt" class="text-muted">-</span>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button 
                        type="button" 
                        class="btn btn-outline-primary btn-sm" 
                        (click)="openTicketModal('edit', ticket)"
                        [disabled]="loading">
                        <i class="fas fa-edit"></i>
                      </button>
                      <!-- <button 
                        type="button" 
                        class="btn btn-outline-danger btn-sm" 
                        (click)="deleteTicket(ticket.id!)"
                        [disabled]="loading">
                        <i class="fas fa-trash"></i>
                      </button> -->
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Add/Edit Ticket Modal -->
<div class="modal fade" id="addTicketModal" tabindex="-1" aria-labelledby="addTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title text-white" id="addTicketModalLabel">{{ isEditMode ? 'Update' : 'Add' }} Ticket</h6>
        <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close" (click)="resetTicketForm()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="title" class="form-label">Title *</label>
                <input 
                  type="text" 
                  id="title" 
                  formControlName="title" 
                  class="form-control"
                  [class.is-invalid]="f['title'].invalid && (f['title'].dirty || f['title'].touched)"
                  placeholder="Enter ticket title">
                <div *ngIf="f['title'].invalid && (f['title'].dirty || f['title'].touched)" class="invalid-feedback">
                  <div *ngIf="f['title'].errors?.['required']">Title is required</div>
                  <div *ngIf="f['title'].errors?.['minlength']">Title must be at least 3 characters</div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="type" class="form-label">Type *</label>
                <select 
                  id="type" 
                  formControlName="type" 
                  class="form-select"
                  [class.is-invalid]="f['type'].invalid && (f['type'].dirty || f['type'].touched)">
                  <option value="">Select Type</option>
                  <option *ngFor="let type of types" [value]="type">{{ type }}</option>
                </select>
                <div *ngIf="f['type'].invalid && (f['type'].dirty || f['type'].touched)" class="invalid-feedback">
                  <div *ngIf="f['type'].errors?.['required']">Type is required</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="form-group mb-3">
                <label for="description" class="form-label">Description *</label>
                <textarea 
                  id="description" 
                  formControlName="description" 
                  class="form-control"
                  rows="4"
                  [class.is-invalid]="f['description'].invalid && (f['description'].dirty || f['description'].touched)"
                  placeholder="Describe the issue or request in detail"></textarea>
                <div *ngIf="f['description'].invalid && (f['description'].dirty || f['description'].touched)" class="invalid-feedback">
                  <div *ngIf="f['description'].errors?.['required']">Description is required</div>
                  <div *ngIf="f['description'].errors?.['minlength']">Description must be at least 10 characters</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="priority" class="form-label">Priority *</label>
                <select 
                  id="priority" 
                  formControlName="priority" 
                  class="form-select"
                  [class.is-invalid]="f['priority'].invalid && (f['priority'].dirty || f['priority'].touched)">
                  <option value="">Select Priority</option>
                  <option *ngFor="let priority of priorities" [value]="priority">{{ priority }}</option>
                </select>
                <div *ngIf="f['priority'].invalid && (f['priority'].dirty || f['priority'].touched)" class="invalid-feedback">
                  <div *ngIf="f['priority'].errors?.['required']">Priority is required</div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="status" class="form-label">Status *</label>
                <select 
                  id="status" 
                  formControlName="status" 
                  class="form-select"
                  [class.is-invalid]="f['status'].invalid && (f['status'].dirty || f['status'].touched)">
                  <option value="">Select Status</option>
                  <option *ngFor="let status of statuses" [value]="status">{{ status.replace('_', ' ') }}</option>
                </select>
                <div *ngIf="f['status'].invalid && (f['status'].dirty || f['status'].touched)" class="invalid-feedback">
                  <div *ngIf="f['status'].errors?.['required']">Status is required</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
              <label for="assigneeId" class="form-label">Assignee *</label>
              <select
                id="assigneeId"
                formControlName="assigneeId"
                class="form-select"
                [class.is-invalid]="f['assigneeId'].invalid && (f['assigneeId'].dirty || f['assigneeId'].touched)">
                <option value="">Select Assignee</option>
                <option *ngFor="let assignee of getAssineeData" [value]="assignee.userId">
                {{ assignee.userId }}
                </option>
              </select>
              <div *ngIf="f['assigneeId'].invalid && (f['assigneeId'].dirty || f['assigneeId'].touched)" class="invalid-feedback">
                <div *ngIf="f['assigneeId'].errors?.['required']">Assignee is required</div>
              </div>
              </div>
            </div>

            <!-- <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="assigneeName" class="form-label">Assignee Name *</label>
                <input 
                  type="text" 
                  id="assigneeName" 
                  formControlName="assigneeName" 
                  class="form-control"
                  [class.is-invalid]="f['assigneeName'].invalid && (f['assigneeName'].dirty || f['assigneeName'].touched)"
                  placeholder="Enter assignee name">
                <div *ngIf="f['assigneeName'].invalid && (f['assigneeName'].dirty || f['assigneeName'].touched)" class="invalid-feedback">
                  <div *ngIf="f['assigneeName'].errors?.['required']">Assignee name is required</div>
                </div>
              </div>
            </div> -->
          </div>

          <div class="row">
            <div class="col-12">
              <div class="form-group mb-3">
                <label for="files" class="form-label">Attach Files</label>
                <input 
                  type="file" 
                  id="files" 
                  multiple 
                  (change)="onFileSelect($event)" 
                  class="form-control"
                  accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif">
                
                <!-- Selected Files Display -->
                <div *ngIf="selectedFiles.length > 0" class="selected-files mt-2">
                  <h6 class="text-muted">Selected Files:</h6>
                  <div *ngFor="let file of selectedFiles; let i = index" class="file-item d-flex justify-content-between align-items-center p-2 border rounded mb-1">
                    <span><i class="fas fa-file me-2" *ngIf="isEditMode"></i>{{ file.fileName }}</span>
                    <span><i class="fas fa-file me-2" *ngIf="!isEditMode"></i>{{ file?.name }}</span>
                    <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeFile(i)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-end mt-3">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal" (click)="resetTicketForm()">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn btn-lime-green" 
              [disabled]="loading || ticketForm.invalid">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
              {{ isEditMode ? 'Update Ticket' : 'Create Ticket' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Delete Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this ticket? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDeleteTicket(deleteTicketId)" [disabled]="loading">
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
